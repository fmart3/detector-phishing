<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberTrust | Analytics Core</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --blue: #3b82f6;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
        }

        /* HEADER MEJORADO */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            padding-bottom: 20px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Nuevo contenedor de botones */

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            border: none;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #334155;
            color: white;
        }

        .btn-primary:hover {
            background: #475569;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #334155;
            color: var(--muted);
        }

        .btn-secondary:hover {
            border-color: var(--blue);
            color: var(--blue);
        }

        /* INPUTS EN CARTAS */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .select-input {
            background: #0f172a;
            color: var(--text);
            border: 1px solid #334155;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: 'Inter';
            outline: none;
        }

        .select-input:focus {
            border-color: var(--blue);
        }

        /* ESTILOS PREVIOS MANTENIDOS... */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--muted);
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 1rem;
            transition: 0.3s;
        }

        .tab-btn.active {
            color: var(--blue);
            border-bottom-color: var(--blue);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #334155;
        }

        .metric-val {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
        }

        .verdict-banner {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid;
        }

        .verdict-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--green);
            color: #d1fae5;
        }

        .verdict-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--yellow);
            color: #fef3c7;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #334155;
            color: var(--blue);
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #334155;
            color: var(--muted);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .bg-red {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .bg-yellow {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .bg-green {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        canvas {
            max-height: 300px;
            width: 100%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <!-- LOGIN OVERLAY -->
    <div id="login-overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <div
            style="background: #1e293b; padding: 40px; border-radius: 12px; border: 1px solid #334155; text-align: center; max-width: 400px; width: 90%;">
            <h2 style="margin-top: 0; color: #f1f5f9;">üîí Acceso Restringido</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">Por favor ingrese la contrase√±a de seguridad para acceder al
                dashboard.</p>
            <input type="password" id="dashboard-password" placeholder="Contrase√±a..."
                style="width: 100%; padding: 12px; margin-bottom: 20px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 6px; box-sizing: border-box;">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width: 100%;">Ingresar</button>
            <a href="/" class="btn btn-secondary"
                style="width: 100%; margin-top: 10px; box-sizing: border-box; text-align: center; display: block;">‚¨Ö
                Volver</a>
            <p id="login-error" style="color: #ef4444; margin-top: 15px; display: none;">Contrase√±a incorrecta</p>
        </div>
    </div>

    <div id="dashboard-content" style="display: none;">

        <div class="header">
            <div>
                <h1>üõ°Ô∏è Dashboard Ejecutivo</h1>
                <div class="subtitle">An√°lisis de Riesgo Humano y Auditor√≠a de IA</div>
            </div>
            <div class="header-actions">
                <a href="/" class="btn btn-secondary">‚¨Ö Volver a Encuesta</a>
                <button class="btn btn-primary" onclick="location.reload()">üîÑ Actualizar</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('tab-resumen', event)">üìä Resumen</button>
            <button class="tab-btn" onclick="openTab('tab-lab', event)">üß™ Laboratorio IA</button>
            <button class="tab-btn" onclick="openTab('tab-data', event)">üìÑ Datos Crudos</button>
        </div>

        <div id="tab-resumen" class="tab-content active">
            <div class="metric-grid">
                <div class="metric-box"><span class="metric-val" id="kpi-total">--</span><span
                        class="metric-label">Encuestas</span></div>
                <div class="metric-box"><span class="metric-val" id="kpi-high" style="color: var(--red)">--</span><span
                        class="metric-label">Riesgo Alto</span></div>
                <div class="metric-box"><span class="metric-val" id="kpi-avg" style="color: var(--blue)">--%</span><span
                        class="metric-label">Prob. Promedio</span></div>
            </div>
            <div class="grid">
                <div class="card">
                    <h3 style="margin-top:0">Distribuci√≥n de Riesgo</h3>
                    <canvas id="chartDona"></canvas>
                </div>
                <div class="card">
                    <h3 style="margin-top:0">Perfil Psicol√≥gico (Big 5)</h3>
                    <canvas id="chartRadar"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-lab" class="tab-content">
            <div id="verdict-box" class="verdict-banner">Cargando diagn√≥stico...</div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3 style="margin:0">An√°lisis: Probabilidad vs Categor√≠a</h3>
                        <select id="histSelector" class="select-input" onchange="updateHistChart()">
                            <option value="General">Susceptibilidad Phishing</option>
                            <option value="Demo_Pais">Por Pa√≠s</option>
                            <option value="Demo_Tipo_Organizacion">Por Tipo Org.</option>
                            <option value="Demo_Industria">Por Industria</option>
                            <option value="Demo_Tamano_Org">Por Tama√±o Org.</option>
                            <option value="Demo_Rol_Trabajo">Por Rol</option>
                            <option value="Demo_Generacion_Edad">Por Generaci√≥n</option>
                            <option value="Demo_Genero">Por G√©nero</option>
                            <option value="Demo_Nivel_Educacion">Por Educaci√≥n</option>
                            <option value="Demo_Horas">Por Horas Conexi√≥n</option>
                        </select>
                    </div>
                    <div style="height: 250px;"><canvas id="chartHist"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 style="margin:0">Correlaci√≥n Din√°mica</h3>
                        <select id="scatterSelector" class="select-input" onchange="updateScatterChart()">
                            <option value="Big5_Extraversion">Extraversi√≥n</option>
                            <option value="Big5_Amabilidad">Amabilidad</option>
                            <option value="Big5_Responsabilidad">Responsabilidad</option>
                            <option value="Big5_Neuroticismo">Neuroticismo</option>
                            <option value="Big5_Apertura">Apertura</option>
                            <option value="Phish_Actitud_Riesgo">Actitud al Riesgo</option>
                            <option value="Phish_Awareness">Awareness</option>
                            <option value="Phish_Riesgo_Percibido">Riesgo Percibido</option>
                            <option value="Phish_Autoeficacia">Autoeficacia</option>
                            <option value="Phish_Susceptibilidad">Susceptibilidad</option>
                            <option value="Fatiga_Global_Score">Fatiga Global</option>
                        </select>
                    </div>
                    <div style="height: 250px;">
                        <canvas id="chartScatter"></canvas>
                    </div>
                    <p style="font-size:0.8rem; color:var(--muted); text-align:center; margin-top:10px;">
                        Eje Y siempre es "Probabilidad de Phishing" (0.0 - 1.0)
                    </p>
                </div>
            </div>
        </div>

        <div id="tab-data" class="tab-content">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items: center;">
                    <h3>√öltimos Registros</h3>
                    <button class="btn btn-primary" onclick="downloadCSV()"
                        style="font-size:0.8rem; padding: 8px 15px;">üì• Descargar CSV</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Probabilidad</th>
                                <th>Riesgo</th>
                                <th>Fatiga</th>
                                <th>Susceptibilidad</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        let globalData = null;
        let globalScatterFull = null;
        let globalHistogram = null; // New global for histogram data
        let scatterChartInstance = null;
        let histChartInstance = null; // New instance for Hist/Bar chart

        // Mappings for Categories (Value -> Label)
        const demoOptions = {
            "Demo_Pais": { 1: "Chile", 2: "Colombia", 3: "Honduras", 4: "M√©xico", 5: "Panam√°" },
            "Demo_Tipo_Organizacion": { 1: "P√∫blica", 2: "Privada", 3: "Sin fines de lucro", 4: "Otra" },
            "Demo_Industria": { 1: "Agricultura", 2: "Bancos o Financiera", 3: "Seguros", 4: "Tecnolog√≠a", 5: "Publicidad", 6: "Transporte", 7: "Salud", 8: "AFP", 9: "P√∫blico", 10: "Energ√≠a", 11: "Miner√≠a", 12: "Oil & Gas", 13: "Retail", 14: "Educaci√≥n", 15: "Consultoria", 16: "Construcci√≥n", 17: "Manufactura", 18: "Otras" },
            "Demo_Tamano_Org": { 1: "<100", 2: "100-500", 3: "500-1k", 4: "1k-3k", 5: "3k-10k", 6: "10k-50k", 7: ">50k" },
            "Demo_Rol_Trabajo": { 1: "Liderazgo", 2: "Supervisi√≥n", 3: "Administrativo", 4: "Otro" },
            "Demo_Generacion_Edad": { 1: "Tradicionalistas", 2: "Baby Boomers", 3: "Gen X", 4: "Millennials", 5: "Gen Z" },
            "Demo_Genero": { 1: "Masculino", 2: "Femenino", 3: "No Binario" },
            "Demo_Nivel_Educacion": { 1: "Primaria", 2: "Universitario", 3: "Diplomado", 4: "Magister", 5: "Doctorado" },
            "Demo_Horas": { 1: "< 2h", 2: "2-5h", 3: "5-8h", 4: "8-10h", 5: "> 10h" }
        };

        function openTab(tabId, event) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (event) event.currentTarget.classList.add('active');
        }

        async function loadDashboard() {
            try {
                const res = await fetch('/dashboard-data');
                const data = await res.json();

                if (data.empty) {
                    document.querySelector('.grid').innerHTML = "<h2>Sin datos.</h2>";
                    return;
                }

                globalData = data.raw_data;
                globalScatterFull = data.scatter_full_data; // Data para scatter

                globalHistogram = data.histogram; // Save histogram data

                // KPIs y Gr√°ficos Est√°ticos
                document.getElementById('kpi-total').innerText = data.total_responses;
                document.getElementById('kpi-high').innerText = data.risk_counts.ALTO || 0;
                document.getElementById('kpi-avg').innerText = data.avg_risk + "%";

                new Chart(document.getElementById('chartDona'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Bajo', 'Medio', 'Alto'],
                        datasets: [{
                            data: [data.risk_counts.BAJO, data.risk_counts.MEDIO, data.risk_counts.ALTO],
                            backgroundColor: ['#10b981', '#facc15', '#ef4444'], borderWidth: 0
                        }]
                    },
                    options: { plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }, cutout: '70%' }
                });

                if (data.big5_radar) {
                    new Chart(document.getElementById('chartRadar'), {
                        type: 'radar',
                        data: {
                            labels: data.big5_radar.labels,
                            datasets: [{
                                label: 'Promedio Org.', data: data.big5_radar.data,
                                borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)'
                            }]
                        },
                        options: { scales: { r: { suggestedMin: 1, suggestedMax: 5, grid: { color: '#334155' }, ticks: { display: false } } } }
                    });
                }

                if (data.health_check) {
                    const vBox = document.getElementById('verdict-box');
                    vBox.className = `verdict-banner verdict-${data.health_check.color}`;
                    vBox.innerHTML = `<strong>${data.health_check.status}:</strong> ${data.health_check.message}`;
                }

                // --- INICIALIZAR HISTOGRAMA ---
                updateHistChart(); // Default: General

                // --- INICIALIZAR SCATTER ---
                updateScatterChart(); // Llama a la funci√≥n que crea el gr√°fico por primera vez

                // Tabla
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                data.raw_data.forEach(row => {
                    const badgeClass = row.risk_level === 'ALTO' ? 'bg-red' : (row.risk_level === 'MEDIO' ? 'bg-yellow' : 'bg-green');
                    tbody.innerHTML += `
                        <tr>
                            <td>${row.timestamp || '--'}</td>
                            <td>${(row.probability * 100).toFixed(1)}%</td>
                            <td><span class="badge ${badgeClass}">${row.risk_level}</span></td>
                            <td>${row.Fatiga_Global_Score?.toFixed(2) || '-'}</td>
                            <td>${row.Phish_Susceptibilidad?.toFixed(2) || '-'}</td>
                        </tr>`;
                });

            } catch (e) { console.error(e); }
        }

        // --- FUNCI√ìN DIN√ÅMICA DE HISTOGRAMA / CATEGOR√çAS ---
        function updateHistChart() {
            const selector = document.getElementById('histSelector').value;
            const ctx = document.getElementById('chartHist');

            if (histChartInstance) histChartInstance.destroy();

            let labels = [];
            let values = [];
            let labelText = "Frecuencia";
            let color = '#6366f1';

            if (selector === 'General') {
                if (!globalHistogram) return;
                labels = globalHistogram.labels;
                values = globalHistogram.data;
            } else {
                // Categorical Mode
                if (!globalScatterFull) return;

                // Aggregate Data
                const groups = {}; // Key -> {sum: 0, count: 0}
                const mapping = demoOptions[selector] || {};

                globalScatterFull.forEach(item => {
                    const val = item[selector];
                    if (val) { // Ignore missing values (0)
                        const key = mapping[val] || "Otro";
                        if (!groups[key]) groups[key] = { sum: 0, count: 0 };
                        groups[key].sum += item.probability;
                        groups[key].count += 1;
                    }
                });

                // Calculate Averages
                labels = Object.keys(groups);
                values = labels.map(k => (groups[k].sum / groups[k].count).toFixed(2));
                labelText = "Probabilidad Promedio";
                color = '#f59e0b';
            }

            histChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: values,
                        backgroundColor: color,
                        borderRadius: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { color: '#334155' },
                            beginAtZero: true,
                            max: selector === 'General' ? undefined : 1.0 // Probabilidad max 1
                        },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- FUNCI√ìN DIN√ÅMICA PARA EL SCATTER ---
        function updateScatterChart() {
            if (!globalScatterFull) return;

            // 1. Obtener variable seleccionada del dropdown
            const xKey = document.getElementById('scatterSelector').value;

            // 2. Mapear datos
            const points = globalScatterFull.map(item => ({
                x: item[xKey], // Valor din√°mico (Fatiga, Edad, etc)
                y: item.probability
            }));

            const colors = globalScatterFull.map(item =>
                item.risk_level === 'ALTO' ? '#ef4444' : (item.risk_level === 'MEDIO' ? '#facc15' : '#10b981')
            );

            // 3. Destruir anterior si existe
            if (scatterChartInstance) {
                scatterChartInstance.destroy();
            }

            // 4. Crear nuevo gr√°fico
            const ctx = document.getElementById('chartScatter');
            scatterChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Usuarios',
                        data: points,
                        backgroundColor: colors,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: xKey.replace(/_/g, ' '), color: '#94a3b8' },
                            grid: { color: '#334155' }, ticks: { color: '#94a3b8' }
                        },
                        y: {
                            title: { display: true, text: 'Probabilidad Phishing', color: '#94a3b8' },
                            grid: { color: '#334155' }, ticks: { color: '#94a3b8' },
                            min: 0, max: 1
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${xKey}: ${ctx.parsed.x}, Prob: ${ctx.parsed.y.toFixed(2)}`
                            }
                        }
                    }
                }
            });
        }

        function downloadCSV() {
            if (!globalData || globalData.length === 0) {
                alert("No hay datos para descargar");
                return;
            }
            const headers = Object.keys(globalData[0]);
            const csvRows = [headers.join(',')];

            globalData.forEach(row => {
                const values = headers.map(header => {
                    let val = row[header];
                    if (val === null || val === undefined) val = '';
                    val = val.toString().replace(/"/g, '""'); // Escapar comillas dobles
                    return `"${val}"`;
                });
                csvRows.push(values.join(','));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_cybertrust_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Iniciar carga (ELIMINADO - Ahora se llama tras login)
        // loadDashboard();

        async function attemptLogin() {
            const pwd = document.getElementById('dashboard-password').value;
            const errorMsg = document.getElementById('login-error');

            try {
                const response = await fetch('/verify-dashboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });

                const result = await response.json(); // Ahora esperamos JSON, no redirect

                if (result.valid) {
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('dashboard-content').style.display = 'block';
                    loadDashboard(); // Cargar datos ahora
                } else {
                    errorMsg.style.display = 'block';
                }
            } catch (e) {
                console.error("Login error:", e);
                errorMsg.innerText = "Error de conexi√≥n";
                errorMsg.style.display = 'block';
            }
        }

        // Permitir Enter para enviar
        document.getElementById('dashboard-password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                attemptLogin();
            }
        });
    </script>
</body>

</html>