<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Seguridad | CyberTrust</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0b1120;
            --card-bg: #1e293b;
            --primary: #3b82f6;
            --accent: #0ea5e9;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* --- HEADER --- */
        header {
            width: 100%;
            padding: 15px 0;
            background: rgba(11, 17, 32, 0.95);
            text-align: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }
        
        .brand-badge {
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        h1 { margin: 0; font-size: 1.3rem; font-weight: 600; color: white; }

        /* --- CONTENEDORES --- */
        .main-container {
            width: 90%;
            max-width: 700px;
            margin-top: 40px;
            animation: fadeIn 0.5s ease-out;
        }

        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* --- PORTADA --- */
        #intro-view { text-align: left; }
        .intro-title {
            font-size: 1.8rem; font-weight: 700; margin-bottom: 15px;
            background: linear-gradient(90deg, #fff, #94a3b8);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .intro-text { line-height: 1.6; color: #cbd5e1; margin-bottom: 20px; font-size: 1rem; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 30px 0; }
        .info-box { background: rgba(59, 130, 246, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2); }
        .info-box h4 { margin: 0 0 8px 0; color: var(--accent); font-size: 1rem; }
        .info-box p { margin: 0; font-size: 0.9rem; color: var(--text-muted); }

        .start-btn {
            width: 100%; padding: 18px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .start-btn:hover { background: var(--primary-hover); transform: translateY(-2px); }

        /* --- ESTILOS DE PREGUNTAS (CUADRADOS CORREGIDOS) --- */
        #survey-view { display: none; } 

        .progress-container {
            width: 100%; height: 4px; background-color: var(--border);
            position: fixed; top: 0; left: 0; z-index: 101; display: none;
        }
        .progress-bar {
            height: 100%; width: 0%; background-color: var(--accent); transition: width 0.4s ease;
        }

        .question-text { 
            font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; 
            color: white; border-left: 3px solid var(--accent); padding-left: 15px;
        }
        
        /* === CORRECCI√ìN VISUAL LIKERT === */
        .likert-wrapper { margin-bottom: 40px; }
        
        .likert-scale {
            display: flex; 
            justify-content: space-between; 
            gap: 12px; /* Espacio entre opciones */
        }
        
        .likert-option { 
            flex: 1; 
            position: relative; 
            /* Esto es vital: crea el contexto de posicionamiento */
            height: 50px; 
        }
        
        /* INPUT INVISIBLE (EL √ÅREA DE CLIC) */
        .likert-option input { 
            position: absolute; 
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%; 
            margin: 0; /* CR√çTICO: Elimina m√°rgenes default del navegador */
            padding: 0;
            opacity: 0; 
            cursor: pointer; 
            z-index: 10; /* Asegura que est√© siempre encima */
        }
        
        /* CUADRADO VISUAL */
        .likert-square {
            position: absolute; /* Para que coincida exacto con el input */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: bold;
            color: var(--text-muted);
            transition: all 0.2s ease;
            z-index: 1; /* Debajo del input */
            box-sizing: border-box; /* Evita que el borde aumente el tama√±o */
        }
        
        /* Hover del Input afecta al cuadrado hermano */
        .likert-option input:hover + .likert-square {
            border-color: var(--accent);
            color: white;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px); /* Peque√±a elevaci√≥n */
        }

        /* Seleccionado */
        .likert-option input:checked + .likert-square {
            background: var(--primary); 
            border-color: var(--accent); 
            color: white; 
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .likert-legend { 
            display: flex; justify-content: space-between; 
            font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; padding: 0 2px;
        }
        /* ================================= */

        /* Form Styles */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        .form-group select {
            width: 100%; padding: 14px; background: #0f172a; border: 1px solid var(--border);
            color: white; border-radius: 8px; font-size: 1rem; outline: none;
        }
        .form-group select:focus { border-color: var(--accent); }

        /* Footer Nav */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(11, 17, 32, 0.95); padding: 15px 0;
            display: flex; justify-content: center; gap: 15px;
            border-top: 1px solid var(--border); backdrop-filter: blur(10px); z-index: 500;
            display: none; 
        }
        .nav-btn {
            padding: 12px 25px; border-radius: 8px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer;
        }
        #btn-next { background: var(--primary); color: white; }
        #btn-back { background: var(--border); color: white; }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Resultados */
        #resultCard { display: none; text-align: center; padding: 40px; }
        .dash-trigger {
            position: fixed; top: 15px; left: 15px; z-index: 2000;
            background: transparent; border: none; color: #334155; font-size: 1.2rem; cursor: pointer;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <button class="dash-trigger" onclick="location.href='/dashboard'">‚öô</button>

    <div class="progress-container" id="progressBarContainer">
        <div id="progress-bar" class="progress-bar"></div>
    </div>

    <header>
        <span class="brand-badge">CyberTrust Security</span>
        <h1>Evaluaci√≥n de Riesgo Humano</h1>
    </header>

    <div class="main-container" id="intro-view">
        <div class="card">
            <h2 class="intro-title">Bienvenido/a</h2>
            
            <p class="intro-text">
                En <strong>CyberTrust</strong>, la seguridad comienza con las personas.
            </p>
            
            <p class="intro-text">
                Esta evaluaci√≥n nos ayuda a entender y fortalecer nuestra cultura de ciberseguridad. Tus respuestas son confidenciales y nos permiten dise√±ar mejores estrategias de protecci√≥n.
            </p>

            <div class="info-grid">
                <div class="info-box">
                    <h4>üõ°Ô∏è Prevenci√≥n</h4>
                    <p>Detectamos riesgos antes de que se conviertan en incidentes.</p>
                </div>
                <div class="info-box">
                    <h4>‚è±Ô∏è R√°pido</h4>
                    <p>Solo tomar√° unos <strong>5 minutos</strong> de tu tiempo.</p>
                </div>
                <div class="info-box">
                    <h4>üîí Privado</h4>
                    <p>Tus datos son tratados con estricta confidencialidad.</p>
                </div>
            </div>

            <button class="start-btn" onclick="startSurvey()">Comenzar Evaluaci√≥n</button>
        </div>
    </div>

    <div class="main-container" id="survey-view">
        <div class="card" id="survey-content">
            <h3 style="text-align:center; color: var(--text-muted);">Cargando...</h3>
        </div>
    </div>

    <div class="main-container" id="resultCard">
        <div class="card">
            <h2 style="margin-top:0">Evaluaci√≥n Completada</h2>
            <p style="color: var(--text-muted);">Tu perfil de riesgo actual:</p>
            
            <h1 id="resultTitle" style="font-size: 3rem; margin: 20px 0;">--</h1>
            <p id="resultSubtitle" style="color: white; font-weight: bold;"></p>

            <div id="resultExplanation" style="background: rgba(255,255,255,0.05); text-align: left; padding: 25px; border-radius: 12px; margin-top: 25px; color: #e2e8f0; line-height: 1.6; border: 1px solid var(--border);">
            </div>

            <button class="nav-btn" onclick="location.reload()" style="margin-top: 30px; background: #334155; color: white; width: 100%;">Finalizar</button>
        </div>
    </div>

    <div class="nav-bar" id="survey-nav">
        <button class="nav-btn" id="btn-back" disabled>Atr√°s</button>
        <button class="nav-btn" id="btn-next">Siguiente</button>
    </div>

<script>
    function startSurvey() {
        document.getElementById('intro-view').style.display = 'none';
        document.getElementById('survey-view').style.display = 'block';
        document.getElementById('survey-nav').style.display = 'flex';
        document.getElementById('progressBarContainer').style.display = 'block';
        initSurvey();
    }

    let currentStepIndex = 0;
    let surveyConfig = [];
    let globalOptions = {};
    const responses = {};

    async function initSurvey() {
        try {
            const res = await fetch('/static/questions.json');
            if (res.ok) {
                const data = await res.json();
                surveyConfig = data.survey;
                globalOptions = data.options;
                renderStep();
            } else {
                throw new Error("Error al cargar questions.json");
            }
        } catch (e) {
            console.error(e);
            document.getElementById('survey-content').innerHTML = `<p style='text-align:center; color:red'>Error de carga. Recarga la p√°gina.</p>`;
        }
    }

    function renderStep() {
        const container = document.getElementById('survey-content');
        const step = surveyConfig[currentStepIndex];
        
        const progress = Math.round(((currentStepIndex) / (surveyConfig.length)) * 100);
        document.getElementById('progress-bar').style.width = progress + '%';

        let html = '';

        if (step.type === 'intro') {
            currentStepIndex++;
            renderStep();
            return;
        }

        if(step.title) {
            html += `<h2 style="color:var(--accent); margin-top:0; margin-bottom: 20px;">${step.title}</h2>`;
            if(step.description) html += `<p style="color:var(--text-muted); margin-bottom: 30px;">${step.description}</p>`;
        }

        // --- LIKERT SQUARES ---
        if (step.type === 'likert') {
            step.questions.forEach(q => {
                const val = responses[q.code];
                html += `
                    <div class="likert-wrapper">
                        <div class="question-text">${q.text}</div>
                        <div class="likert-scale">
                            ${[1,2,3,4,5].map(n => `
                                <div class="likert-option">
                                    <input type="radio" 
                                           name="${q.code}" 
                                           id="${q.code}_${n}"
                                           value="${n}" 
                                           ${val == n ? 'checked' : ''} 
                                           onchange="saveResp('${q.code}', ${n})">
                                    
                                    <div class="likert-square">
                                        ${n}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="likert-legend">
                            <span>Totalmente en Desacuerdo</span>
                            <span>Totalmente de Acuerdo</span>
                        </div>
                    </div>
                `;
            });
        }

        // --- FORMULARIO ---
        else if (step.type === 'form') {
            step.questions.forEach(q => {
                const val = responses[q.code] || "";
                
                let optionsList = [];
                if (q.options_id && globalOptions[q.options_id]) {
                    optionsList = globalOptions[q.options_id];
                } else if (q.options) {
                    optionsList = q.options.map(o => ({v: o, t: o}));
                }

                html += `
                    <div class="form-group">
                        <label>${q.text}</label>
                        <select onchange="saveResp('${q.code}', this.value)">
                            <option value="">Seleccione una opci√≥n...</option>
                            ${optionsList.map(opt => `
                                <option value="${opt.v}" ${val == opt.v ? 'selected' : ''}>${opt.t}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });
        }

        container.innerHTML = html;
        window.scrollTo(0,0);
        updateButtons();
    }

    function updateButtons() {
        const btnBack = document.getElementById('btn-back');
        const btnNext = document.getElementById('btn-next');
        
        btnBack.disabled = (currentStepIndex === 0);
        btnBack.onclick = () => { currentStepIndex--; renderStep(); };

        if (currentStepIndex === surveyConfig.length - 1) {
            btnNext.innerText = "Enviar Evaluaci√≥n";
            btnNext.onclick = submitSurvey;
            btnNext.style.background = "#10b981";
        } else {
            btnNext.innerText = "Siguiente";
            btnNext.onclick = validateAndNext;
            btnNext.style.background = "";
        }
    }

    window.saveResp = (code, val) => { 
        responses[code] = isNaN(val) ? val : Number(val); 
    };

    function validateAndNext() {
        const step = surveyConfig[currentStepIndex];
        if(step.questions) {
            const missing = step.questions.some(q => !responses[q.code]);
            if(missing) { 
                alert("Por favor responde todas las preguntas."); 
                return; 
            }
        }
        currentStepIndex++;
        renderStep();
    }

    async function submitSurvey() {
        const btn = document.getElementById('btn-next');
        btn.innerText = "Procesando...";
        btn.disabled = true;

        try {
            const res = await fetch('/analyze', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(responses)
            });

            const result = await res.json();
            
            if(result.status === 'success' || result.final_record) {
                document.getElementById('survey-view').style.display = 'none';
                document.getElementById('survey-nav').style.display = 'none';
                showResultCard(result.final_record.model_output);
            } else {
                alert("Error: " + (result.message || "Error desconocido"));
                btn.innerText = "Reintentar";
                btn.disabled = false;
            }

        } catch (e) {
            console.error(e);
            alert("Error de conexi√≥n.");
            btn.innerText = "Enviar Evaluaci√≥n";
            btn.disabled = false;
        }
    }

    function showResultCard(output) {
        const card = document.getElementById('resultCard');
        const title = document.getElementById('resultTitle');
        const sub = document.getElementById('resultSubtitle');
        const exp = document.getElementById('resultExplanation');

        card.style.display = 'block';

        const risk = output.risk_level || "BAJO";
        let color = "#4ade80"; 
        let textInfo = "Tu cultura de seguridad es fuerte.";
        
        if(risk === 'MEDIO') { 
            color = "#facc15"; 
            textInfo = "Buen nivel, pero cuidado con el exceso de confianza.";
        }
        if(risk === 'ALTO') { 
            color = "#ef4444"; 
            textInfo = "Riesgo detectado. Te sugerimos revisar las gu√≠as de seguridad.";
        }

        title.innerText = risk;
        title.style.color = color;
        sub.innerText = `Nivel de Riesgo`;
        exp.innerHTML = textInfo;
        exp.style.borderLeft = `4px solid ${color}`;
    }
</script>

</body>
</html>